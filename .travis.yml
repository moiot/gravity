language: go

go:
  - "1.11"

install: true

services:
  - docker

jobs:
  include:
    - name: "build"
      script:
        - make build-linux
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker build -t $DOCKER_USERNAME/gravity:${TRAVIS_COMMIT::8} -f Dockerfile.gravity .
        - docker push $DOCKER_USERNAME/gravity:${TRAVIS_COMMIT::8}
        - docker build -t $DOCKER_USERNAME/gravity-operator:${TRAVIS_COMMIT::8} -f Dockerfile.operator .
        - docker push $DOCKER_USERNAME/gravity-operator:${TRAVIS_COMMIT::8}
        - docker build -t $DOCKER_USERNAME/gravity-gatekeeper:${TRAVIS_COMMIT::8} -f Dockerfile.gatekeeper .
        - docker push $DOCKER_USERNAME/gravity-gatekeeper:${TRAVIS_COMMIT::8}
    - name: "test"
      script: make test
      after_script: make test-down