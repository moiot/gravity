version: '3.2'
services:
  source-db:
    image: mysql:5.7
    container_name: source-db-test
    environment:
      - MYSQL_ALLOW_EMPTY_PASSWORD=yes
    command:
      # test for binlog rotate case
      - --max-binlog-size=409600
    logging:
      driver: none
    volumes:
      - ./mycnf:/etc/mysql/conf.d

  target-db:
    image: mysql:5.7
    container_name: target-db-test
    environment:
      - MYSQL_ALLOW_EMPTY_PASSWORD=yes
    logging:
      driver: none
    volumes:
      - ./mycnf:/etc/mysql/conf.d

  mongo:
    container_name: mongo
    build:
      context: ./
      dockerfile: Dockerfile.mongo.setup
    ports:
      - 27017
    logging:
      driver: none
    command: mongod --replSet rs1

  zookeeper:
    image: zookeeper:3.4.10
    container_name: zookeeper
    logging:
      driver: none

  kafka:
    image: confluentinc/cp-kafka:5.1.0
    container_name: kafka
    depends_on:
      - zookeeper
    environment:
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    logging:
      driver: none

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:6.3.2
    container_name: elasticsearch
    environment:
      - http.host=0.0.0.0
      - xpack.security.transport.filter.allow=0.0.0.0
      - cluster.name=gravity
      - "ES_JAVA_OPTS=-Xms750m -Xmx750m"
    logging:
      driver: none
      
  pd:
    image: pingcap/pd:latest
    ports:
      - "2379"
    volumes:
      - ./integration_test/config/pd.toml:/pd.toml:ro
    command:
      - --name=pd
      - --client-urls=http://0.0.0.0:2379
      - --peer-urls=http://0.0.0.0:2380
      - --advertise-client-urls=http://pd:2379
      - --advertise-peer-urls=http://pd:2380
      - --initial-cluster=pd=http://pd:2380
      - --data-dir=/data/pd
      - --config=/pd.toml
    restart: on-failure

  tikv:
    image: pingcap/tikv:latest
    volumes:
      - ./integration_test/config/tikv.toml:/tikv.toml:ro
    command:
      - --addr=0.0.0.0:20160
      - --advertise-addr=tikv:20160
      - --data-dir=/data/tikv
      - --pd=pd:2379
      - --config=/tikv.toml
    depends_on:
      - "pd"
    restart: on-failure

  pump:
    image: pingcap/tidb-binlog:latest
    logging:
      driver: none
    volumes:
      - ./integration_test/config/pump.toml:/pump.toml:ro
    command:
      - /pump
      - --addr=0.0.0.0:8250
      - --advertise-addr=pump:8250
      - --data-dir=/data/pump
      - --node-id=pump
      - --pd-urls=http://pd:2379
      - --config=/pump.toml
    depends_on:
      - "pd"
    restart: on-failure

  drainer:
    image: pingcap/tidb-binlog:latest
    logging:
      driver: none
    volumes:
      - ./integration_test/config/drainer.toml:/drainer.toml:ro
    command:
      - /drainer
      - --addr=drainer:8249
      - --data-dir=/data/data.drainer
      - --pd-urls=http://pd:2379
      - --config=/drainer.toml
      - --initial-commit-ts=0
      - --dest-db-type=kafka
    depends_on:
      - "pd"
      - "kafka"
    restart: on-failure

  tidb:
    image: pingcap/tidb:latest
    ports:
      - "4000:4000"
      - "10080:10080"
    volumes:
      - ./integration_test/config/tidb.toml:/tidb.toml:ro
    command:
      - --store=tikv
      - --path=pd:2379
      - --config=/tidb.toml
      - --enable-binlog=true
    depends_on:
      - "tikv"
      - "pump"
    restart: on-failure

  gravity-test:
    build:
      context: ./
      dockerfile: Dockerfile.test.gravity
    depends_on:
      - mongo
      - tidb
    environment:
      - MONGO_HOST=mongo
      - KAFKA_BROKER=kafka:9092
      - ELASTICSEARCH_URLS=http://elasticsearch:9200
    command: ["bash", "./wait-for-it.sh", "source-db:3306","-t", "0",
              "--", "./wait-for-it.sh", "target-db:3306","-t", "0",
              "--", "./wait-for-it.sh", "mongo:27017", "-t", "0",
              "--", "./wait-for-it.sh", "kafka:9092", "-t", "0",
              "--", "./wait-for-it.sh", "elasticsearch:9200", "-t", "0",
              "--", "./wait-for-it.sh", "tidb:4000", "-t", "0",
              "--", "make", "go-test"]
